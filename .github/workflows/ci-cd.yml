name: ğŸš€ CI/CD Pipeline - Ordem do Dia

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/**"
      - "!.github/workflows/**"
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ğŸ§ª TESTES E QUALIDADE
  tests:
    name: ğŸ§ª Testes e Qualidade de CÃ³digo
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Cache de dependÃªncias
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            .venv
            */build
            */dist
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}-${{ hashFiles('**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          python -m venv .venv
          .venv/Scripts/Activate.ps1
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist black flake8 mypy bandit safety doc8

      - name: ğŸ“š Validar documentaÃ§Ã£o
        run: |
          doc8 docs/ README.md --ignore D001

      - name: ğŸ¨ Verificar formataÃ§Ã£o (Black)
        run: |
          black --check --diff .

      - name: ğŸ” Linting (Flake8)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: ğŸ”’ VerificaÃ§Ã£o de seguranÃ§a (Bandit)
        run: |
          # Executar anÃ¡lise com parÃ¢metros de linha de comando (mais confiÃ¡vel)
          echo "ğŸ” Executando anÃ¡lise de seguranÃ§a com Bandit..."
          bandit -r . --exclude=.venv,tests,build_temp,htmlcov,distribuicao,distribuicao_completa --skip=B101,B601,B603,B607 -f json -o bandit-report.json || true

          # Executar verificaÃ§Ã£o focada em problemas crÃ­ticos
          echo "ğŸ¯ Verificando apenas problemas crÃ­ticos (Medium/High)..."
          bandit -r . --exclude=.venv,tests,build_temp,htmlcov,distribuicao,distribuicao_completa --skip=B101,B601,B603,B607 --severity-level medium --confidence-level medium

          # Processar e mostrar resultados usando script Python
          python security_check.py || echo "âš ï¸ Script de verificaÃ§Ã£o nÃ£o disponÃ­vel - usando validaÃ§Ã£o bÃ¡sica"

      - name: ğŸ›¡ï¸ Verificar vulnerabilidades (Safety)
        run: |
          safety check --json --output safety-report.json || true
          safety check

      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: |
          pytest tests/ -v -n auto --dist loadfile \
            --cov=. --cov-report=html --cov-report=xml \
            --cov-fail-under=70 \
            --junit-xml=test-results.xml

      - name: ğŸ“Š Upload coverage para Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ“ˆ Publicar resultados de teste
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: test-results
          path: test-results.xml

      - name: ğŸ“‹ Artefatos de relatÃ³rios
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            htmlcov/
            bandit-report.json
            safety-report.json
            coverage.xml

  # ğŸ”¨ BUILD DO EXECUTÃVEL
  build:
    name: ğŸ”¨ Build ExecutÃ¡vel Windows
    runs-on: windows-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'release'

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NecessÃ¡rio para gerar changelog

      - name: ğŸ”„ Gerar Changelog
        id: changelog
        uses: heinrichreimer/github-changelog-generator-action@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output: CHANGELOG.md
          excludeLabels: duplicate,question,invalid,wontfix
          breakingLabel: "### âš ï¸ Breaking Changes"
          enhancementLabel: "### ğŸš€ Melhorias"
          bugsLabel: "### ğŸ› CorreÃ§Ãµes de Bugs"
          deprecatedLabel: "### âš ï¸ Deprecated"
          removedLabel: "### ğŸ—‘ï¸ Removido"
          securityLabel: "### ğŸ”’ SeguranÃ§a"
          issuesLabel: "### ğŸ“‹ Outras Issues"

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          python -m venv .venv
          .venv/Scripts/Activate.ps1
          pip install -r requirements.txt
          pip install pyinstaller

      - name: ğŸ”¨ Build ExecutÃ¡vel
        run: |
          .venv/Scripts/Activate.ps1
          python build_exe.py

      - name: ğŸ“ Assinar ExecutÃ¡vel
        env:
          CERTIFICATE_BASE64: ${{ secrets.SIGNING_CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          # Decodificar certificado
          $certBytes = [Convert]::FromBase64String($env:CERTIFICATE_BASE64)
          $certPath = "certificate.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          # Assinar executÃ¡vel
          ./sign_executable.ps1 -CertPath $certPath -CertPassword $env:CERTIFICATE_PASSWORD -FilePath "distribuicao/GeradorOD.exe"

      - name: ğŸ“¦ Criar DistribuiÃ§Ã£o Completa
        run: |
          .venv/Scripts/Activate.ps1

          # Preparar pasta de distribuiÃ§Ã£o
          $dist = "distribuicao_completa"
          Remove-Item -Path $dist -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path $dist

          # Copiar arquivos
          Copy-Item "distribuicao/GeradorOD.exe" "$dist/"
          Copy-Item "README.txt" "$dist/"
          Copy-Item "config_dias_filmagem.json" "$dist/"
          Copy-Item -Path "arquivos" -Destination "$dist/" -Recurse

          # Criar ZIP
          $version = (Get-Date -Format "yyyy.MM.dd")
          Compress-Archive -Path "$dist/*" -DestinationPath "GeradorOD-$version.zip"

      - name: ğŸ“¤ Upload Artefatos
        uses: actions/upload-artifact@v4
        with:
          name: GeradorOD
          path: |
            distribuicao/GeradorOD.exe
            GeradorOD-*.zip
            CHANGELOG.md

  # ğŸš€ RELEASE
  publish_release:
    name: ğŸš€ Publicar Release
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'release'

    steps:
      - name: ğŸ“¥ Download Artefatos
        uses: actions/download-artifact@v4
        with:
          name: GeradorOD

      - name: ğŸ“‹ Ler Changelog
        id: changelog
        run: |
          $changelog = Get-Content CHANGELOG.md -Raw
          $changelog = $changelog -replace "`n","%0A"
          echo "::set-output name=content::$changelog"

      - name: ğŸ‰ Criar Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            GeradorOD-*.zip
            distribuicao/GeradorOD.exe
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Instalar dependÃªncias de build
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: ğŸ”¨ Gerar executÃ¡vel
        run: |
          python build_exe.py

      - name: ğŸ›¡ï¸ AnÃ¡lise de seguranÃ§a do executÃ¡vel
        run: |
          # Verificar se o executÃ¡vel foi criado
          if (Test-Path "distribuicao_completa/GeradorOD.exe") {
            Write-Host "âœ… ExecutÃ¡vel encontrado"
            
            # Verificar integridade do arquivo
            $hash = Get-FileHash "distribuicao_completa/GeradorOD.exe" -Algorithm SHA256
            Write-Host "ğŸ” Hash SHA256: $($hash.Hash)"
            
            # Criar arquivo de hash para verificaÃ§Ã£o
            $hash.Hash | Out-File "distribuicao_completa/GeradorOD.exe.sha256"
            
            # Verificar tamanho (executÃ¡veis muito pequenos ou grandes podem ser suspeitos)
            $size = (Get-Item "distribuicao_completa/GeradorOD.exe").Length / 1MB
            Write-Host "ğŸ“Š Tamanho: $([math]::Round($size, 2)) MB"
            
            if ($size -lt 10 -or $size -gt 200) {
              Write-Host "âš ï¸ Tamanho incomum detectado - revisar se necessÃ¡rio"
            }
            
            # Verificar se nÃ£o Ã© um arquivo de texto (indicaria falha no build)
            $fileType = file "distribuicao_completa/GeradorOD.exe" 2>$null
            if ($fileType -match "text") {
              Write-Error "âŒ ExecutÃ¡vel parece ser arquivo de texto - build falhou"
              exit 1
            }
            
          } else {
            Write-Error "âŒ ExecutÃ¡vel nÃ£o foi criado!"
            exit 1
          }

      - name: âœ… Verificar executÃ¡vel
        run: |
          if (Test-Path "distribuicao_completa/GeradorOD.exe") {
            Write-Host "âœ… ExecutÃ¡vel criado com sucesso!"
            $size = (Get-Item "distribuicao_completa/GeradorOD.exe").Length / 1MB
            Write-Host "ğŸ“Š Tamanho: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "âŒ ExecutÃ¡vel nÃ£o foi criado!"
            exit 1
          }

      - name: ğŸ§ª Teste bÃ¡sico do executÃ¡vel
        run: |
          # Teste se o executÃ¡vel inicia sem erros (modo CLI) com timeout
          $exePath = "distribuicao_completa/GeradorOD.exe"
          if (Test-Path $exePath) {
            $startInfo = New-Object System.Diagnostics.ProcessStartInfo
            $startInfo.FileName = $exePath
            $startInfo.Arguments = "--help"
            $startInfo.UseShellExecute = $false
            $startInfo.RedirectStandardOutput = $true
            $startInfo.RedirectStandardError = $true
            $process = New-Object System.Diagnostics.Process
            $process.StartInfo = $startInfo
            $process.Start() | Out-Null
            # Timeout de 15 segundos
            if ($process.WaitForExit(15000)) {
              if ($process.ExitCode -eq 0) {
                Write-Host "âœ… ExecutÃ¡vel passou no teste bÃ¡sico"
              } else {
                Write-Host "âš ï¸ ExecutÃ¡vel retornou cÃ³digo: $($process.ExitCode)"
              }
            } else {
              Write-Host "âŒ Timeout: ExecutÃ¡vel nÃ£o respondeu em 15 segundos"
              $process.Kill()
              exit 1
            }
          } else {
            Write-Error "âŒ ExecutÃ¡vel nÃ£o encontrado para teste!"
            exit 1
          }

      - name: ğŸ“¦ Criar pacote de distribuiÃ§Ã£o
        run: |
          # Executar script de assinatura (sem certificado, apenas validaÃ§Ã£o)
          Write-Host "ğŸ” Executando validaÃ§Ã£o de seguranÃ§a do executÃ¡vel..."
          pwsh -ExecutionPolicy Bypass -File "sign_executable.ps1" -ExecutablePath "distribuicao_completa/GeradorOD.exe"

          # Criar ZIP com distribuiÃ§Ã£o completa
          $version = "v2.0-$(Get-Date -Format 'yyyyMMdd')-$($env:GITHUB_SHA.Substring(0,7))"
          Compress-Archive -Path "distribuicao_completa/*" -DestinationPath "OrdemDoDia-$version.zip"

          # Criar hash do arquivo
          $hash = Get-FileHash "OrdemDoDia-$version.zip" -Algorithm SHA256
          $hash.Hash | Out-File "OrdemDoDia-$version.zip.sha256"

          Write-Host "ğŸ“¦ Pacote criado: OrdemDoDia-$version.zip"

          # Criar manifesto de seguranÃ§a
          $manifest = @{
            version = $version
            build_date = (Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
            commit_hash = $env:GITHUB_SHA
            executable_hash = (Get-FileHash "distribuicao_completa/GeradorOD.exe" -Algorithm SHA256).Hash
            package_hash = $hash.Hash
            security_scan = "passed"
            signed = "false"
          }

          $manifest | ConvertTo-Json | Out-File "OrdemDoDia-$version.manifest.json" -Encoding UTF8
          Write-Host "ğŸ›¡ï¸ Manifesto de seguranÃ§a criado"

      - name: ğŸ“¤ Upload artefatos
        uses: actions/upload-artifact@v4
        with:
          name: executavel-windows
          path: |
            OrdemDoDia-*.zip
            OrdemDoDia-*.zip.sha256
            OrdemDoDia-*.manifest.json
          retention-days: 30

  # ğŸš€ RELEASE AUTOMÃTICO
  release:
    name: ğŸš€ Create Release
    runs-on: windows-latest
    needs: [tests, build]
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: ğŸ“¥ Download artefatos
        uses: actions/download-artifact@v4
        with:
          name: executavel-windows

      - name: ğŸš€ Upload para Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            OrdemDoDia-*.zip
            OrdemDoDia-*.zip.sha256
            OrdemDoDia-*.manifest.json
          body: |
            ## ğŸ‰ Nova versÃ£o do Ordem do Dia!

            ### ğŸ“¦ Arquivos de Download
            - **OrdemDoDia-*.zip**: AplicaÃ§Ã£o completa com executÃ¡vel
            - **OrdemDoDia-*.zip.sha256**: Hash SHA256 para verificaÃ§Ã£o
            - **OrdemDoDia-*.manifest.json**: Manifesto de seguranÃ§a e integridade

            ### ğŸš€ Como Usar
            1. Baixe o arquivo ZIP
            2. Extraia em uma pasta de sua escolha
            3. Execute `GeradorOD.exe`
            4. Siga as instruÃ§Ãµes na interface

            ### ğŸ“‹ Requisitos
            - Windows 10/11 (64-bit)
            - 4GB RAM mÃ­nimo
            - 100MB espaÃ§o livre

            ### ğŸ†˜ Suporte
            - ğŸ“– Manual: IncluÃ­do no ZIP
            - ğŸ› Issues: [GitHub Issues](https://github.com/${{ github.repository }}/issues)
            - ğŸ“§ Email: [Contato do desenvolvedor]

            ---
            **Testado em**: Windows 10, Windows 11  
            **Build**: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ“‹ NOTIFICAÃ‡Ã•ES E LINKS
  notify:
    name: ğŸ“‹ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [tests, build]
    if: always()

    steps:
      - name: ğŸ”— ComentÃ¡rio com link do artefato
        if: needs.tests.result == 'success' && needs.build.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.runId;
            const repo = context.repo;
            const sha = context.sha;

            const artifactUrl = `https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId}`;
            const downloadUrl = `${artifactUrl}#artifacts`;

            const comment = `## ğŸ‰ Build ConcluÃ­do com Sucesso!

            ### ğŸ“¦ **Download Direto do ExecutÃ¡vel**
            ğŸ”— **[BAIXAR EXECUTÃVEL AQUI](${downloadUrl})**

            ### ğŸ“Š **Resultados do Build**
            - âœ… **Testes**: ${context.payload.workflow_run?.conclusion || 'Passou'} 
            - âœ… **Build**: Sucesso
            - ğŸ—ï¸ **Commit**: \`${sha.substring(0, 7)}\`
            - ğŸ“… **Data**: ${new Date().toLocaleString('pt-BR')}

            ### ğŸš€ **Links RÃ¡pidos**
            - ğŸ“‹ [Ver Logs Completos](${artifactUrl})
            - ğŸ“¦ [Download Artefatos](${downloadUrl})
            - ğŸ” [Detalhes do Commit](https://github.com/${repo.owner}/${repo.repo}/commit/${sha})

            ### ğŸ’¡ **Como Baixar**
            1. Clique no link **"BAIXAR EXECUTÃVEL AQUI"** acima
            2. Role atÃ© a seÃ§Ã£o "Artifacts" 
            3. Clique em **"executavel-windows"**
            4. O download comeÃ§arÃ¡ automaticamente

            ---
            ğŸ¤– *ComentÃ¡rio automÃ¡tico do CI/CD*`;

            // Se for um push, comenta no commit
            if (context.eventName === 'push') {
              await github.rest.repos.createCommitComment({
                owner: repo.owner,
                repo: repo.repo,
                commit_sha: sha,
                body: comment
              });
            }

            // Se for um PR, comenta no PR
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

      - name: ğŸ’¬ Notificar sucesso
        if: needs.tests.result == 'success' && needs.build.result == 'success'
        run: |
          echo "âœ… Pipeline executado com sucesso!"
          echo "ğŸ§ª Testes: PASSOU"
          echo "ğŸ”¨ Build: PASSOU"
          echo "ğŸ”— Link do artefato postado automaticamente!"

      - name: ğŸš¨ Notificar falha
        if: needs.tests.result == 'failure' || needs.build.result == 'failure'
        run: |
          echo "âŒ Pipeline falhou!"
          echo "ğŸ§ª Testes: ${{ needs.tests.result }}"
          echo "ğŸ”¨ Build: ${{ needs.build.result }}"
          exit 1
